/*
 * courier
 * 0.0.1
 * Ferris Tseng
 * 2013-08-08 09:08
 */
!function(){window.isFirefox="undefined"!=typeof InstallTrigger,window.isChrome=null!=window.chrome&&null!=window.chrome.webstore}.call(this),function(){var EventEmitter,Logger,Token,logger,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};Token=function(){function Token(){}return Token.__rand__=function(){return Math.random().toString(36).substr(2)},Token.generate=function(){return Token.__rand__()+Token.__rand__()},Token}(),Logger=function(){function Logger(cls){this.cls=cls}return Logger.prototype.log=function(msg){return window.console?console.log(""+this.cls+" -> "+msg):void 0},Logger}(),logger=new Logger("Util"),EventEmitter=function(){function EventEmitter(){this.handlers={}}return EventEmitter.prototype.on=function(key,handler){return __indexOf.call(this.handlers,key)<0&&(this.handlers[key]=[]),this.handlers[key].push(handler)-1},EventEmitter.prototype.once=function(key,handler){var index;return index=this.on(key,handler),this.on(key,function(){return this.handlers[key].splice(index,2)})},EventEmitter.prototype.trigger=function(key){return logger.log("Triggered "+key+"!"),this.__execute_handlers__.apply(this,arguments)},EventEmitter.prototype.__execute_handlers__=function(key){var n,_i,_len,_ref,_results;if(key in this.handlers){for(_ref=this.handlers[key],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)n=_ref[_i],_results.push(n.apply(this,Array.prototype.slice.call(arguments,1)));return _results}},EventEmitter}(),window.Token=Token,window.Logger=Logger,window.EventEmitter=EventEmitter}.call(this),function(){var FileStorage,IndexedDBFileStorage,logger,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};logger=new Logger("FileStorage"),FileStorage=function(){function FileStorage(){}return FileStorage.prototype.storeChunk=function(){},FileStorage.prototype.assembleChunks=function(){},FileStorage.prototype.getChunk=function(){},FileStorage.prototype.cleanUp=function(){},FileStorage}(),IndexedDBFileStorage=function(_super){function IndexedDBFileStorage(){var self;self=this,this.db=null,this.onready=null,this.request=indexedDB.open(IndexedDBFileStorage.DB_NAME),this.request.onsuccess=function(event){return self.db=event.target.result,null!=self.onready?self.onready():void 0},this.request.onupgradeneeded=function(event){return self.db=event.target.result,self.db.createObjectStore(IndexedDBFileStorage.DB_STORE,{keyPath:"id"}).createIndex("name","name",{unique:!1}),null!=self.onready?self.onready():void 0}}return __extends(IndexedDBFileStorage,_super),IndexedDBFileStorage.DB_NAME="DownloadFileStorage",IndexedDBFileStorage.DB_STORE="files",IndexedDBFileStorage.prototype.getObjectStore=function(type){return null==type&&(type="read"),this.db?this.db.transaction([IndexedDBFileStorage.DB_STORE],type).objectStore(IndexedDBFileStorage.DB_STORE):void 0},IndexedDBFileStorage.prototype.storeChunk=function(chunk,chunk_num,f_name,f_type,onsuccess,onerror){var e,r;if(this.db)try{return r=this.getObjectStore("readwrite").add({id:""+f_name+"_"+chunk_num,name:f_name,chunk_num:chunk_num,data:new Blob([chunk],{type:f_type})}),r.onsuccess=onsuccess,r.onerror=onerror}catch(_error){return e=_error,console.log(e)}},IndexedDBFileStorage.prototype.getChunk=function(chunk_num,f_name,onsuccess,onerror){var e,r;if(this.db)try{return r=this.getObjectStore().get(""+f_name+"_"+chunk_num),r.onsuccess=onsuccess,r.onerror=onerror}catch(_error){return e=_error,console.log(e)}},IndexedDBFileStorage.prototype.assembleChunks=function(f_name,f_type,onsuccess){var allChunks,e,r;if(this.db)try{return r=this.getObjectStore().index("name").openCursor(IDBKeyRange.only(f_name)),allChunks=[],request.onsuccess=function(event){var cursor;return cursor=event.target.result,cursor?(allChunks.push(cursor.value.data),cursor["continue"]()):onsuccess(new Blob(allChunks,{type:f_type}))}}catch(_error){return e=_error,console.log(e)}},IndexedDBFileStorage.prototype.cleanUp=function(){return logger.log("Not yet implemented!")},IndexedDBFileStorage}(FileStorage),window.FileStorage=isFirefox?new IndexedDBFileStorage:void 0}.call(this),function(){var PrivateChannel,SignalingChannel,WebsocketChannel,logger,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};logger=new Logger("SignalingChannel"),SignalingChannel=function(_super){function SignalingChannel(){SignalingChannel.__super__.constructor.apply(this,arguments)}return __extends(SignalingChannel,_super),SignalingChannel.prototype.join=function(){},SignalingChannel.prototype.send=function(){},SignalingChannel}(EventEmitter),WebsocketChannel=function(_super){function WebsocketChannel(){var self;self=this,this.ws=new WebSocket("ws://localhost:8000"),this.ws.onopen=function(){return self.__onopen__()},this.ws.onmessage=function(e){return self.__onmessage__(e)},this.ws.onclose=function(){return self.__onclose__()},WebsocketChannel.__super__.constructor.apply(this,arguments)}return __extends(WebsocketChannel,_super),WebsocketChannel.prototype.__send__=function(event,data){return logger.log("Sending [event] "+event+" [data] "+data+"..."),this.ws.send(JSON.stringify({type:event,data:data}))},WebsocketChannel.prototype.__onopen__=function(){return this.trigger("open")},WebsocketChannel.prototype.__onmessage__=function(event){var e;return e=JSON.parse(event),this.trigger("message"),this.trigger(e.type,e.data)},WebsocketChannel.prototype.__onclose__=function(){return this.trigger("close")},WebsocketChannel.prototype.join=function(room){return this.__send__("join",room)},WebsocketChannel.prototype.send=function(event,data){return this.__send__(event,data)},WebsocketChannel}(SignalingChannel),PrivateChannel=function(_super){function PrivateChannel(){return _ref=PrivateChannel.__super__.constructor.apply(this,arguments)}return __extends(PrivateChannel,_super),PrivateChannel}(SignalingChannel),window.SignalingChannel=new WebsocketChannel}.call(this),function(){var ChromeRTCImplementation,FirefoxRTCImplementation,WebRTCImplementation,_ref,_ref1,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};WebRTCImplementation=function(){function WebRTCImplementation(){this.servers={iceServers:[{url:"stun:stun.l.google.com:19302"}]},this.onicecandidate=null}return WebRTCImplementation.handleSession=function(peer,session,callback){return peer.setLocalDescription(session),callback(session)},WebRTCImplementation.prototype.createPeer=function(){},WebRTCImplementation.prototype.createChannel=function(){},WebRTCImplementation.prototype.createOffer=function(){},WebRTCImplementation.prototype.handleOffer=function(){},WebRTCImplementation.prototype.createAnswer=function(){},WebRTCImplementation.prototype.handleAnswer=function(){},WebRTCImplementation.prototype.addIceCandidate=function(){},WebRTCImplementation}(),FirefoxRTCImplementation=function(_super){function FirefoxRTCImplementation(){return _ref=FirefoxRTCImplementation.__super__.constructor.apply(this,arguments)}return __extends(FirefoxRTCImplementation,_super),FirefoxRTCImplementation.mediaConstraints={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},FirefoxRTCImplementation.prototype.createPeer=function(){return new mozRTCPeerConnection(this.servers)},FirefoxRTCImplementation.prototype.createChannel=function(peer,channel,options){return peer.createDataChannel(channel,options)(peer?void 0:null)},FirefoxRTCImplementation.prototype.createOffer=function(peer,callback){return callback=function(session){return WebRTCImplementation.handleSession(peer,session,callback)},navigator.mozGetUserMedia({audio:!0,fake:!0},function(stream){return peer.addStream(stream),peer.createOffer(callback,null,FirefoxRTCImplementation.mediaConstraints)})},FirefoxRTCImplementation.prototype.handleOffer=function(){var peer;return peer=createPeer(),peer.ondatachannel=function(e){return peer.channel=e.channel},peer},FirefoxRTCImplementation.prototype.createAnswer=function(peer,callback){return callback=function(session){return WebRTCImplementation.handleSession(peer,session,callback)},navigator.mozGetUserMedia({audio:!0,fake:!0},function(stream){return peer.addStream(stream),peer.createAnswer(callback,null,FirefoxRTCImplementation.mediaConstraints)})},FirefoxRTCImplementation.prototype.handleAnswer=function(peer){return peer.setRemoteDescription(new mozRTCSessionDescription)},FirefoxRTCImplementation.prototype.addIceCandidate=function(peer,candidate){return peer.addIceCandidate(new mozRTCIceCandidate(candidate))},FirefoxRTCImplementation}(WebRTCImplementation),ChromeRTCImplementation=function(_super){function ChromeRTCImplementation(){return _ref1=ChromeRTCImplementation.__super__.constructor.apply(this,arguments)}return __extends(ChromeRTCImplementation,_super),ChromeRTCImplementation.config={optional:[{RtpDataChannels:!0}]},ChromeRTCImplementation.mediaConstraints={optional:[],mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}},ChromeRTCImplementation.prototype.createPeer=function(){var peer;return peer=new webkitRTCPeerConnection(this.servers,ChromeRTCImplementation.config),peer.onicecandidate=this.onicecandidate},ChromeRTCImplementation.prototype.createChannel=function(peer,channel,options){return options||(options={reliable:!1}),peer.createDataChannel(channel,options)},ChromeRTCImplementation.prototype.createOffer=function(peer,callback){return callback=function(session){return WebRTCImplementation.handleOffer(peer,session,callback)},peer.createOffer(callback,null,ChromeRTCImplementation.mediaConstraints)},ChromeRTCImplementation.prototype.handleOffer=function(){var peer;return peer=this.createPeer()},ChromeRTCImplementation.prototype.createAnswer=function(peer,callback){return callback=function(session){return WebRTCImplementation.handleOffer(peer,session,callback)},peer.createAnswer(callback,null,ChromeRTCImplementation.mediaConstraints)},ChromeRTCImplementation.prototype.handleAnswer=function(peer,answer){return peer.setRemoteDescription(new RTCSessionDescription(answer))},ChromeRTCImplementation.prototype.addIceCandidate=function(peer,candidate){return peer.addIceCandidate(new RTCIceCandidate(candidate))},ChromeRTCImplementation}(WebRTCImplementation),window.WebRTCImplementation=isChrome?new ChromeRTCImplementation:isFirefox?new FirefoxRTCImplementation:void 0}.call(this),function(){var CHUNK_SIZE,ChunkedFile,Client,Host,P2PClientConnection,P2PConnection,P2PHostConnection,P2PMember,TIMEOUT,logger,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};CHUNK_SIZE=2097152,TIMEOUT=6e3,logger=new Logger("P2P"),ChunkedFile=function(){function ChunkedFile(f,chunk_size){this.f=f,this.chunk_size=chunk_size,this.name=this.f.name,this.type=this.f.type?this.f.type:"unknown",this.size=this.f.size,this.read=0,this.chunks=parseInt(Math.ceil(this.f.size/this.chunk_size))}return ChunkedFile.prototype.slice=function(start,end){return this.f.slice(start,end)},ChunkedFile.prototype.end=function(){return this.read===this.chunks},ChunkedFile}(),P2PMember=function(_super){function P2PMember(){var self;self=this,FileStorage.onready=function(){return self.trigger("storageReady")},P2PMember.__super__.constructor.apply(this,arguments)}return __extends(P2PMember,_super),P2PMember}(EventEmitter),P2PConnection=function(_super){function P2PConnection(){this.peer=null,this.channel=null,this.status=0,P2PConnection.__super__.constructor.apply(this,arguments)}return __extends(P2PConnection,_super),P2PConnection.prototype.changeStatus=function(s){return this.status=s,this.trigger("statusChange",s)},P2PConnection}(EventEmitter),P2PClientConnection=function(_super){function P2PClientConnection(){return _ref=P2PClientConnection.__super__.constructor.apply(this,arguments)}return __extends(P2PClientConnection,_super),P2PClientConnection.prototype.start=function(){return this.peer=WebRTCImplementation.createPeer(),this.channel=WebRTCImplementation.createChannel(this.peer),WebRTCImplementation.createAnswer(this.peer,function(o){return SignalingChannel.send(o)}),this.changeStatus(1)},P2PClientConnection}(P2PConnection),P2PHostConnection=function(_super){function P2PHostConnection(token,id){this.token=token,this.id=id,P2PHostConnection.__super__.constructor.apply(this,arguments),SignalingChannel.on("open",function(){return this.join(token),this.send("clientId",id)}),this.changeStatus(1)}return __extends(P2PHostConnection,_super),P2PHostConnection.prototype.start=function(offer){return this.peer=WebRTCImplementation.handleOffer(offer),WebRTCImplementation.createAnswer(this.peer,function(a){return SignalingChannel.send(a)}),this.changeStatus(2)},P2PHostConnection}(P2PConnection),Host=function(_super){function Host(){var self;self=this,this.clients=[],this.reader=new FileReader,this.readChunk=function(start,end){return this.reader.readAsArrayBuffer(this.file.slice(start,end))},this.reader.onloadend=function(){var token;return self.file.read++,self.trigger("readProgress",self.file.read,self.file.chunks),self.file.end()?(token=Token.generate(),SignalingChannel.join(token),self.trigger("channelJoin",token),self.trigger("fileEnd",self.file,token)):self.readChunk(self.file.read*CHUNK_SIZE,CHUNK_SIZE*(self.file.read+1))},Host.__super__.constructor.apply(this,arguments)}return __extends(Host,_super),Host.prototype.host=function(file){return this.file=new ChunkedFile(file,CHUNK_SIZE),this.readChunk(0,CHUNK_SIZE),this.file},Host}(P2PMember),Client=function(_super){function Client(){this.id=Token.generate(),this.chunks_remaining=[],this.chunks_downloaded=[],this.chunks_active=[],Client.__super__.constructor.apply(this,arguments)}return __extends(Client,_super),Client.prototype.connect=function(token){return this.host=new P2PHostConnection(token,this.id)},Client}(P2PMember),window.Host=Host,window.Client=Client}.call(this);